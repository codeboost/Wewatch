// Generated by IcedCoffeeScript 1.2.0i
(function() {
  var AppView, PlayerView, Playlist, Skull, createYTFrame, ioState, _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; };

  if (typeof window !== "undefined" && window !== null) {
    if ((_ref = window.module) != null) _ref.enter('app');
  }

  ioState = require('ioState');

  Playlist = require('playlist');

  PlayerView = require('playerView');

  try {
    Skull = require('skull-client');
  } catch (e) {
    Skull = require('skull');
  }

  WWM.Player = null;

  WWM.isModerator = WWM.session.creator === WWM.user._id;

  AppView = (function(_super) {

    __extends(AppView, _super);

    AppView.name = 'AppView';

    function AppView() {
      this.updateViewers = __bind(this.updateViewers, this);
      return AppView.__super__.constructor.apply(this, arguments);
    }

    AppView.prototype.initialize = function() {
      var _this = this;
      this.el = $('#main-container');
      this.playerView = new PlayerView.PlayerView({
        model: WWM.models.video
      });
      this.playlistView = new Playlist.View({
        collection: WWM.models.playlist,
        el: this.$('.playlist-view')
      });
      this.playlistView.collection.bind('selected', function(model) {
        return WWM.models.video.save(model.toJSON());
      });
      WWM.models.users.bind('all', this.updateViewers);
      WWM.models.users.bind('server-broadcast', function(data) {
        return console.log('Server broadcast: ', data);
      });
      this.chatInput = this.$('[name=chat-message]');
      this.chatInput.keyup(function(e) {
        var txt;
        txt = $.trim(_this.chatInput.val());
        if (e.keyCode === 13 && txt.length) {
          return WWM.models.users.broadcast({
            from: WWM.user._id,
            message: txt
          });
        }
      });
      this.playlistView.render();
      return this.updateViewers();
    };

    AppView.prototype.updateViewers = function() {
      return this.$('.viewers').text(WWM.models.users.length + ' viewers');
    };

    return AppView;

  })(Backbone.View);

  createYTFrame = function() {
    var firstTag, tag;
    tag = document.createElement('script');
    tag.src = 'http://www.youtube.com/player_api';
    firstTag = document.getElementsByTagName('script')[0];
    return firstTag.parentNode.insertBefore(tag, firstTag);
  };

  window.onYouTubePlayerAPIReady = function() {
    console.log('Youtube player API ready!');
    console.log('Connecting to server');
    WWM.conn = new ioState.ConnectionState;
    WWM.conn.bind('joined', function(bootstrap) {
      var globalNS;
      globalNS = Skull.createClient(WWM.conn.sio.of(WWM.session._id));
      WWM.models = require('models').init(globalNS, bootstrap);
      return new AppView;
    });
    return WWM.conn.join(WWM.session.docid);
  };

  exports.start = function() {
    return $(function() {
      return createYTFrame();
    });
  };

}).call(this);
